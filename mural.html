<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="r.png">
    <title>feira das profiss√µes</title>
    <link rel="stylesheet" href="ccs teste.css">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
<link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="header-mural">
            <h2>Ol√°, <span id="nomeUsuario">Carregando...</span>!</h2>
            
            <div class="header-mural__user-info">
                <p class="coin-count" id="rubixcoins-display">
                    <i class="fas fa-coins coin-icon"></i> 
                    RubixCoins: R$  <span id="saldoRubixCoins"> 0 </span>
                </p>
            </div>
            
            <div class="header-mural__text">
                <h3>Bem-vindo √† Feira das Profiss√µes!</h3>
                <h5>Este projeto foi desenvolvido como parte de um trabalho acad√™mico com o objetivo de criar um espa√ßo interativo onde usu√°rios podem compartilhar ideias, postar mensagens, comentar e se conectar com outras pessoas. Estamos sempre evoluindo e abertos a sugest√µes. Aproveite e explore a plataforma!</h5>
                <h5>Acumule moedas postando, comentando, jogando e at√© mesmo trocando a foto de perfil</h5>
            </div>
            
            <nav class="header-mural__nav">
                <a href="ranking.html" class="button button-secondary">üèÜ Ver Ranking Completo</a>
                <br>
                <br>
                <button class="header-mural__nav-button" onclick="irParaPerfil()">Ver Perfil</button>
                <br>
                <button class="header-mural__nav-button" onclick="game()">Game</button>
                <br>
                <button class="header-mural__nav-button" onclick="sair()">Sair</button>
            </nav>
        </header>
        
        <div class="layout-flex">
            <main class="main-content">
                <div class="post-form">
                    <div class="post-form__header">
                        <div><img id="fotoPerfilHeader" class="avatar" src="" alt="Foto de Perfil"></div>
                        <div></div>
                    </div>
                    <div class="post-form__content">
                        <textarea id="mensagem" class="post-form__textarea" placeholder="O que est√° acontecendo?"></textarea>
                        
                       <br> <div class="image-preview" id="image-preview-container" style="display: none;">
                            <img id="image-preview" class="image-preview__image" src="#" alt="Preview da imagem">
                            <button id="remove-image-btn" class="image-preview__remove-button">X</button><br>
                        </div>
                        
                        <div class="post-form__actions">
                            <label for="file-upload" class="post-form__action-icon" title="Adicionar imagem">
                                <i class="fas fa-image"></i>
                            </label>
                            <input type="file" id="file-upload" accept="image/*" style="display: none;">
                            
                            <button id="emoji-btn-main" class="post-form__action-icon" title="Adicionar emoji">
                                <i class="fas fa-laugh-beam"></i>
                            </button>
                            
                            <button onclick="postarMensagem()" class="button post-form__submit-button">Rubitar</button>
                        </div>
                    </div>
                </div>
                
                <aside class="ranking-sidebar">
                    <center><h3>üëë Top 3 do Ranking üëë</h3></center>
                    <center><ul id="rankingListTop3"></ul></center>
                    <center><p id="errorMessageRanking" class="message-error" style="display: none;"></p></center>
                </aside>
                
                <div id="mural" class="feed-posts"></div>
            </main>
        </div>
    </div>
    
    <div id="coin-animation-container"></div>
    <emoji-picker style="display: none; position: absolute; z-index: 1000;"></emoji-picker>

    <script>
        // --- Vari√°veis Globais do Script ---
        let currentUser = null;
        let activeTextarea = null;
        let selectedFile = null;

        // --- DECLARA√á√ÉO DAS FUN√á√ïES DA P√ÅGINA (MOVIDAS PARA O TOPO E GLOBALMENTE ACESS√çVEIS) ---
        // Estas fun√ß√µes s√£o chamadas diretamente do HTML (ex: via onclick) ou precisam estar
        // dispon√≠veis globalmente antes que o DOMContentLoaded seja totalmente executado.

        async function carregarPerfilDoUsuario() {
            if (!currentUser) return;
            if (typeof window._supabase === 'undefined') {
                console.error('Supabase client n√£o inicializado ao carregar perfil.');
                return;
            }
            const { data: profile } = await window._supabase.from('profiles').select('username, avatar_url, rubix_coins').eq('id', currentUser.id).single();
            if (profile) {
                document.getElementById("nomeUsuario").textContent = profile.username || 'Visitante';
                document.getElementById("fotoPerfilHeader").src = profile.avatar_url || 'https://img.freepik.com/vetores-premium/icone-de-perfil-de-avatar-padrao-imagem-de-usuario-de-midia-social-icone-de-avatar-cinza-silhueta-de-perfil-em-branco-ilustracao-vetorial_561158-3383.jpg?semt=ais_hybrid&w=740';
                document.getElementById("saldoRubixCoins").textContent = profile.rubix_coins || 0;
            }
        }

        async function carregarMensagens() {
            const mural = document.getElementById("mural");
            mural.innerHTML = "<p>Carregando mural...</p>";
            
            if (typeof window._supabase === 'undefined') {
                console.error('Supabase client n√£o inicializado ao carregar mensagens.');
                mural.innerHTML = "<p>N√£o foi poss√≠vel carregar as mensagens (erro de inicializa√ß√£o do Supabase).</p>";
                return;
            }

            const { data: messages, error } = await window._supabase
                .from('messages')
                .select(`*, profiles (username, avatar_url), comments ( *, profiles (username, avatar_url) )`)
                .order('created_at', { ascending: false });

            if (error) {
                console.error("Erro ao carregar mensagens:", error);
                mural.innerHTML = "<p>N√£o foi poss√≠vel carregar as mensagens.</p>";
                return;
            }
            mural.innerHTML = "";
            
            messages.forEach(msg => {
                const postElement = document.createElement("div");
                postElement.className = "post";
                postElement.id = `post-${msg.id}`;

                const autorNome = msg.profiles ? msg.profiles.username : 'An√¥nimo';
                const autorAvatar = msg.profiles?.avatar_url || 'https://img.freepik.com/vetores-premium/icone-de-perfil-de-avatar-padrao-imagem-de-usuario-de-midia-social-icone-de-avatar-cinza-silhueta-de-perfil-em-branco-ilustracao-vetorial_561158-3383.jpg?semt=ais_hybrid&w=740';
                const commentCount = msg.comments ? msg.comments.length : 0;

                postElement.innerHTML = `
                    <div class="post__header">
                        <img src="${autorAvatar}" class="avatar" alt="Foto de ${autorNome}">
                        <div class="post-info">
                            <strong class="post__author">${autorNome}</strong>
                            <span class="post__date">${new Date(msg.created_at).toLocaleString('pt-BR')}</span>
                        </div>
                    </div>
                    <div class="post__content">
                        ${msg.content ? `<p>${msg.content}</p>` : ''}
                        ${msg.image_url ? `<img src="${msg.image_url}" alt="Imagem do post" class="post__image">` : ''}
                    </div>
                    <div class="post__actions">
                        <button class="post__action-button" onclick="toggleComentarios('${msg.id}')">
                            <i class="fas fa-comment"></i> Comentar <span class="comment-count">${commentCount}</span>
                        </button>
                        ${msg.user_id === currentUser?.id ? `<button class="post__delete-button" onclick="apagarMensagem('${msg.id}')"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                    <div class="comments-section" id="comments-section-${msg.id}" style="display:none;">
                    </div>`;
                mural.appendChild(postElement);
            });
        }

        async function postarMensagem() {
            const texto = document.getElementById("mensagem").value.trim();
            if (texto === "" && !selectedFile) {
                alert("Voc√™ precisa escrever algo ou selecionar uma imagem.");
                return;
            }
            if (!currentUser) return;

            // Verifica se _supabase est√° definido antes de usar
            if (typeof window._supabase === 'undefined') {
                console.error('Supabase client n√£o inicializado ao postar mensagem.');
                alert('Erro: Supabase n√£o inicializado. N√£o foi poss√≠vel postar.');
                return;
            }

            const rubitarBtn = document.querySelector('.post-form__submit-button');
            rubitarBtn.disabled = true;
            rubitarBtn.textContent = 'Publicando...';

            if (selectedFile) {
                const custoImagem = 50;
                const sucesso = await window.gastarRubixCoins(currentUser.id, custoImagem);

                if (!sucesso) {
                    alert(`Voc√™ n√£o tem RubixCoins suficientes! Custa ${custoImagem} moedas para postar uma imagem.`);
                    rubitarBtn.disabled = false;
                    rubitarBtn.textContent = 'Rubitar';
                    return; 
                }
            }

            let imageUrl = null;

            if (selectedFile) {
                const nomeArquivo = `${currentUser.id}-${Date.now()}`;
                const { error: uploadError } = await window._supabase.storage.from('avatars').upload(nomeArquivo, selectedFile);
                if (uploadError) {
                    console.error('Erro no upload:', uploadError);
                    alert('Falha ao enviar a imagem.');
                    rubitarBtn.disabled = false;
                    rubitarBtn.textContent = 'Rubitar';
                    return;
                }
                // O m√©todo getPublicUrl retorna um objeto { data: { publicUrl: '...' } }
                const { data: { publicUrl } } = window._supabase.storage.from('avatars').getPublicUrl(nomeArquivo);
                imageUrl = publicUrl;
            }

            const { error: insertError } = await window._supabase.from('messages').insert({ content: texto, user_id: currentUser.id, image_url: imageUrl });

            if (insertError) {
                console.error("Erro ao postar:", insertError);
                alert('Ocorreu um erro ao postar a mensagem. Tente novamente.');
            } else {
                document.getElementById("mensagem").value = "";
                // Simula o clique no bot√£o de remover imagem para limpar o preview
                document.getElementById('remove-image-btn').click();
                
                if (!selectedFile) { // Se n√£o foi uma postagem com imagem, adiciona as moedas
                    await window.adicionarRubixCoins(currentUser.id, 10);
                }
                
                await carregarMensagens(); // Recarrega o mural
                await carregarPerfilDoUsuario(); // Atualiza o saldo no header
            }

            rubitarBtn.disabled = false;
            rubitarBtn.textContent = 'Rubitar';
        }

        async function apagarMensagem(messageId) {
            if (!confirm("Tem certeza que deseja apagar este post?")) return;
            if (typeof window._supabase === 'undefined') {
                console.error('Supabase client n√£o inicializado ao apagar mensagem.');
                alert('Erro: Supabase n√£o inicializado. N√£o foi poss√≠vel apagar.');
                return;
            }
            const { error } = await window._supabase.from('messages').delete().match({ id: messageId });
            if (error) {
                console.error('Erro ao apagar:', error);
                alert('Ocorreu um erro ao apagar a mensagem. Tente novamente.');
            } else {
                await carregarMensagens(); // Recarrega o mural
            }
        }

        async function toggleComentarios(messageId) {
            const commentsSection = document.getElementById(`comments-section-${messageId}`);
            if (commentsSection) {
                if (commentsSection.style.display === 'none') {
                    commentsSection.style.display = 'block';
                    await carregarComentarios(messageId); // Carrega coment√°rios quando a se√ß√£o √© expandida
                } else {
                    commentsSection.style.display = 'none';
                    // Opcional: Limpar os coment√°rios ao fechar para recarregar na pr√≥xima vez
                    // document.getElementById(`existing-comments-${messageId}`).innerHTML = ''; 
                }
            }
        }

        async function carregarComentarios(messageId) {
            const commentsSection = document.getElementById(`comments-section-${messageId}`);
            if (!commentsSection) return;

            // Inicia com a estrutura de input e mensagem de carregamento
            commentsSection.innerHTML = `
                <div class="comment-input">
                    <textarea id="comment-text-${messageId}" class="comment-input__textarea" placeholder="Escreva um coment√°rio..."></textarea>
                    <button class="comment-input__button emoji-button" data-target-textarea="comment-text-${messageId}">üòÄ</button>
                    <button onclick="postarComentario('${messageId}')" class="comment-input__button">Comentar</button>
                </div>
                <div class="comments-section__list" id="existing-comments-${messageId}">
                    <p>Carregando coment√°rios...</p>
                </div>`;

            const existingCommentsDiv = document.getElementById(`existing-comments-${messageId}`);
            
            if (typeof window._supabase === 'undefined') {
                console.error('Supabase client n√£o inicializado ao carregar coment√°rios.');
                existingCommentsDiv.innerHTML = "<p>Erro ao carregar coment√°rios (Supabase n√£o inicializado).</p>";
                return;
            }

            const { data: comments, error } = await window._supabase
                .from('comments')
                .select('*, profiles (username, avatar_url)')
                .eq('message_id', messageId)
                .order('created_at', { ascending: true });

            if (error) {
                console.error(`Erro ao carregar coment√°rios para a mensagem ${messageId}:`, error);
                existingCommentsDiv.innerHTML = "<p>Erro ao carregar coment√°rios.</p>";
                return;
            }

            if (comments.length === 0) {
                existingCommentsDiv.innerHTML = "<p>Nenhum coment√°rio ainda. Seja o primeiro!</p>";
                return;
            }

            existingCommentsDiv.innerHTML = ''; // Limpa o "Carregando coment√°rios..."

            comments.forEach(comment => {
                const commentElement = document.createElement('div');
                commentElement.className = 'comments-section__item';
                const autorNome = comment.profiles ? comment.profiles.username : 'An√¥nimo';
                const autorAvatar = comment.profiles?.avatar_url || 'https://img.freepik.com/vetores-premium/icone-de-perfil-de-avatar-padrao-imagem-de-usuario-de-midia-social-icone-de-avatar-cinza-silhueta-de-perfil-em-branco-ilustracao-vetorial_561158-3383.jpg?semt=ais_hybrid&w=740';

                commentElement.innerHTML = `
                    <img src="${autorAvatar}" class="avatar" alt="Foto de ${autorNome}">
                    <div class="comments-section__item-content">
                        <strong class="comments-section__item-author">${autorNome}</strong>
                        <span class="post__date">${new Date(comment.created_at).toLocaleString('pt-BR')}</span>
                        <p class="comments-section__item-text">${comment.content}</p>
                        ${comment.user_id === currentUser?.id ? `<button class="delete-button" onclick="apagarComentario('${comment.id}', '${messageId}')"><i class="fas fa-trash"></i></button>` : ''}
                    </div>
                `;
                existingCommentsDiv.appendChild(commentElement);
            });
        }

        async function postarComentario(messageId) {
            const commentTextarea = document.getElementById(`comment-text-${messageId}`);
            const content = commentTextarea.value.trim();

            if (content === "") {
                alert("Por favor, escreva um coment√°rio.");
                return;
            }
            if (!currentUser) {
                alert("Voc√™ precisa estar logado para comentar.");
                return;
            }

            // Verifica se _supabase est√° definido antes de usar
            if (typeof window._supabase === 'undefined') {
                console.error('Supabase client n√£o inicializado ao postar coment√°rio.');
                alert('Erro: Supabase n√£o inicializado. N√£o foi poss√≠vel comentar.');
                return;
            }

            const custoComentario = 5; // Custo para comentar
            const sucesso = await window.gastarRubixCoins(currentUser.id, custoComentario);

            if (!sucesso) {
                alert(`Voc√™ n√£o tem RubixCoins suficientes! Custa ${custoComentario} moedas para comentar.`);
                return;
            }

            const { error } = await window._supabase.from('comments').insert({
                message_id: messageId,
                user_id: currentUser.id,
                content: content
            });

            if (error) {
                console.error("Erro ao postar coment√°rio:", error);
                alert('Ocorreu um erro ao postar o coment√°rio. Tente novamente.');
                // Se der erro ao postar, considere devolver as moedas ou tratar de forma diferente
                // Por simplicidade aqui, n√£o vamos devolver, mas em um app real voc√™ poderia querer isso.
            } else {
                commentTextarea.value = ''; // Limpa o textarea
                await carregarComentarios(messageId); // Recarrega os coment√°rios para mostrar o novo
                await carregarPerfilDoUsuario(); // Atualiza o saldo de RubixCoins no header
            }
        }

        async function apagarComentario(commentId, messageId) {
            if (!confirm("Tem certeza que deseja apagar este coment√°rio?")) return;
            
            if (typeof window._supabase === 'undefined') {
                console.error('Supabase client n√£o inicializado ao apagar coment√°rio.');
                alert('Erro: Supabase n√£o inicializado. N√£o foi poss√≠vel apagar o coment√°rio.');
                return;
            }

            const { error } = await window._supabase.from('comments').delete().match({ id: commentId });

            if (error) {
                console.error('Erro ao apagar coment√°rio:', error);
                alert('Ocorreu um erro ao apagar o coment√°rio. Tente novamente.');
            } else {
                await carregarComentarios(messageId); // Recarrega os coment√°rios para remover o apagado
            }
        }

        async function sair() {
            if (typeof window._supabase === 'undefined') {
                console.error('Supabase client n√£o inicializado ao sair.');
                alert('Erro: Supabase n√£o inicializado. N√£o foi poss√≠vel sair.');
                return;
            }
            await window._supabase.auth.signOut();
            window.location.href = "index.html";
        }

        function irParaPerfil() {    
            window.location.href = "perfil.html";    
        }

        function game() {    
            window.location.href = "pggame.html";    
        }

        async function carregarTop3Ranking() {
            const rankingList = document.getElementById('rankingListTop3');
            const errorMessage = document.getElementById('errorMessageRanking');

            if (!window._supabase) {
                errorMessage.textContent = 'Erro: Supabase n√£o inicializado para o ranking.';
                errorMessage.style.display = 'block';
                return;
            }

            try {
                const { data: profiles, error } = await window._supabase
                    .from('profiles')
                    .select('username, rubix_coins')
                    .order('rubix_coins', { ascending: false })
                    .limit(3);

                if (error) {
                    console.error('Erro ao buscar top 3 ranking:', error.message);
                    errorMessage.textContent = 'Erro ao carregar o top 3 do ranking. Tente novamente mais tarde.';
                    errorMessage.style.display = 'block';
                    return;
                }

                if (profiles.length === 0) {
                    rankingList.innerHTML = '<li class="ranking-sidebar__list-item">Nenhum usu√°rio no top 3 ainda.</li>';
                } else {
                    rankingList.innerHTML = '';
                    profiles.forEach((profile, index) => {
                        const listItem = document.createElement('li');
                        listItem.className = 'ranking-sidebar__list-item';
                        listItem.innerHTML = `
                            <span class="ranking-sidebar__list-item-position">${index + 1}¬∫</span>
                            <span class="ranking-sidebar__list-item-username">${profile.username || 'Usu√°rio An√¥nimo'}</span>
                            <span class="ranking-sidebar__list-item-coins">${profile.rubix_coins || 0} ü™ô</span>
                        `;
                        rankingList.appendChild(listItem);
                    });
                }
            } catch (err) {
                console.error('Erro inesperado ao carregar top 3 ranking:', err);
                errorMessage.textContent = 'Ocorreu um erro inesperado ao carregar o top 3 do ranking.';
                errorMessage.style.display = 'block';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            carregarTop3Ranking();
        });

        // --- L√≥gica Principal da P√°gina (Tudo acontece depois que o HTML carrega) ---
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. AUTENTICA√á√ÉO E CARREGAMENTO INICIAL
            if (typeof window._supabase === 'undefined') {
                console.error('Supabase client not initialized. Cannot proceed with DOMContentLoaded logic.');
                return;
            }

            const { data: { session } } = await window._supabase.auth.getSession();
            if (!session) {
                window.location.href = "index.html";
                return;
            }
            currentUser = session.user;
            await carregarPerfilDoUsuario();
            await carregarMensagens();

            // --- SETUP: UPLOAD DE IMAGEM (PREVIEW E REMO√á√ÉO) ---
            const fileInput = document.getElementById('file-upload');
            const imagePreviewContainer = document.getElementById('image-preview-container');
            const imagePreview = document.getElementById('image-preview');
            const removeImageBtn = document.getElementById('remove-image-btn');

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    selectedFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        imagePreviewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });

            removeImageBtn.addEventListener('click', () => {
                selectedFile = null;
                fileInput.value = '';
                imagePreviewContainer.style.display = 'none';
            });

            // --- SETUP: L√ìGICA DOS EMOJIS (ABRIR, FECHAR, INSERIR) ---
            const emojiPicker = document.querySelector('emoji-picker');

            document.body.addEventListener('click', async (event) => {
                const target = event.target;
                const emojiButton = target.closest('.emoji-button');

                if (emojiButton) {
                    event.stopPropagation();
                    if (!currentUser) return alert("Voc√™ precisa estar logado para usar emojis.");

                    if (await window.gastarRubixCoins(currentUser.id, 5)) {
                        await carregarPerfilDoUsuario();
                        activeTextarea = (emojiButton.id === 'emoji-btn-main')
                            ? document.getElementById('mensagem')
                            : document.getElementById(emojiButton.dataset.targetTextarea);
                        
                        const rect = emojiButton.getBoundingClientRect();
                        emojiPicker.style.top = `${window.scrollY + rect.bottom}px`;
                        emojiPicker.style.left = `${window.scrollX + rect.left - 150}px`;
                        emojiPicker.style.display = 'block';
                    } else {
                        alert(`Custa 5 RubixCoins para usar emojis.`);
                    }
                } else if (emojiPicker.style.display === 'block' && !emojiPicker.contains(target)) {
                    emojiPicker.style.display = 'none';
                }
            });

            emojiPicker.addEventListener('emoji-click', event => {
                if (activeTextarea) {
                    activeTextarea.value += event.detail.unicode;
                }
                emojiPicker.style.display = 'none';
            });

            // --- SETUP: ANIMA√á√ÉO DAS MOEDAS AO CLICAR (NO SALDO DO HEADER) ---
            const rubixcoinsDisplay = document.getElementById('rubixcoins-display');
            const coinAnimationContainer = document.getElementById('coin-animation-container');

            rubixcoinsDisplay.addEventListener('click', () => {
                const coinImage = document.createElement('img');
                coinImage.src = 'coin.png';
                coinImage.classList.add('coin-animation');
                coinAnimationContainer.appendChild(coinImage);

                setTimeout(() => {
                    coinImage.classList.add('coin-animation--fade-out');
                    setTimeout(() => coinImage.remove(), 500);
                }, 1000);
            });
        });
    </script>
</body>
</html>